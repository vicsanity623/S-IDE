<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Sandbox IDE</title>
    
    <!-- CodeMirror Editor Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <style>
        :root {
            --bg-dark: #1e1e2e;
            --bg-panel: #282a36;
            --text-main: #f8f8f2;
            --accent: #bd93f9;
            --border: #44475a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { height: 100vh; display: flex; flex-direction: column; background: var(--bg-dark); color: var(--text-main); }

        /* Toolbar */
        #toolbar { height: 50px; background: var(--bg-panel); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border); justify-content: space-between; }
        .btn { background: var(--accent); color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; color: var(--text-main); border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--border); }

        /* Main Workspace */
        #workspace { display: flex; flex: 1; height: calc(100vh - 50px); }

        /* Sidebar (Files) */
        #sidebar { width: 200px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #8be9fd; }
        #file-list { flex: 1; overflow-y: auto; list-style: none; }
        .file-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-family: monospace; font-size: 14px; }
        .file-item:hover { background: #44475a; }
        .file-item.active { background: var(--accent); color: #000; font-weight: bold; }

        /* Editor Area */
        #editor-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .panel-header { background: var(--bg-panel); padding: 5px 15px; font-size: 13px; font-family: monospace; border-bottom: 1px solid var(--border); color: #f1fa8c; }
        .CodeMirror { flex: 1; height: 100% !important; font-size: 14px; }

        /* Right Panel (Preview + Console) */
        #right-panel { width: 40%; display: flex; flex-direction: column; }
        #preview-container { flex: 1; display: flex; flex-direction: column; border-bottom: 1px solid var(--border); }
        iframe { flex: 1; border: none; background: #fff; width: 100%; }

        #console-container { height: 30%; display: flex; flex-direction: column; background: var(--bg-panel); }
        #console-output { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 13px; color: #f8f8f2; }
        .log-row { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-error { color: #ff5555; }
        .log-warn { color: #f1fa8c; }
        
        .clear-btn { float: right; background: none; border: 1px solid var(--border); color: #fff; cursor: pointer; padding: 2px 6px; border-radius: 3px; font-size: 11px; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div>
            <h2>üõ†Ô∏è Sandbox IDE</h2>
        </div>
        <div>
            <button class="btn" onclick="runCode()">‚ñ∂ Run</button>
        </div>
    </div>

    <div id="workspace">
        <!-- File Manager -->
        <div id="sidebar">
            <div class="sidebar-header">
                Files
                <button class="btn btn-outline" style="padding: 2px 8px;" onclick="createFile()">+</button>
            </div>
            <ul id="file-list"></ul>
        </div>

        <!-- Code Editor -->
        <div id="editor-container">
            <div class="panel-header" id="current-file-name">index.html</div>
            <textarea id="code-editor"></textarea>
        </div>

        <!-- Preview & Console -->
        <div id="right-panel">
            <div id="preview-container">
                <div class="panel-header">Live Preview</div>
                <iframe id="preview"></iframe>
            </div>
            <div id="console-container">
                <div class="panel-header">
                    Console
                    <button class="clear-btn" onclick="clearConsole()">Clear</button>
                </div>
                <div id="console-output"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. Initial File System State (Preloaded with user's specific scenario)
        const files = {
            "index.html": `<canvas id="game"></canvas>\n<script src="index.js"><\/script>`,
            "index.js": `console.log("Canvas Element:", game);\ngame.width = 800;\ngame.height = 800;\nconst ctx = game.getContext("2d");\nconsole.log("2D Context:", ctx);\n\n// Let's draw something to test!\nctx.fillStyle = "blue";\nctx.fillRect(50, 50, 100, 100);`
        };

        let currentFile = "index.html";

        // 2. Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            lineNumbers: true,
            theme: "dracula",
            mode: "htmlmixed",
            tabSize: 2
        });

        // 3. Save code changes to the virtual file system
        editor.on("change", () => {
            files[currentFile] = editor.getValue();
        });

        // 4. UI Rendering Functions
        function renderFileList() {
            const list = document.getElementById("file-list");
            list.innerHTML = "";
            for (const fileName in files) {
                const li = document.createElement("li");
                li.className = "file-item " + (fileName === currentFile ? "active" : "");
                li.innerText = fileName;
                li.onclick = () => openFile(fileName);
                list.appendChild(li);
            }
        }

        function openFile(fileName) {
            currentFile = fileName;
            document.getElementById("current-file-name").innerText = fileName;
            editor.setValue(files[fileName]);
            
            // Switch syntax highlighting mode
            if (fileName.endsWith(".js")) editor.setOption("mode", "javascript");
            else if (fileName.endsWith(".css")) editor.setOption("mode", "css");
            else editor.setOption("mode", "htmlmixed");

            renderFileList();
        }

        function createFile() {
            const fileName = prompt("Enter file name (e.g., style.css, script.js):");
            if (fileName && !files[fileName]) {
                files[fileName] = "";
                openFile(fileName);
            }
        }

        // 5. Console Logic
        function clearConsole() {
            document.getElementById("console-output").innerHTML = "";
        }

        function logToConsole(msg, type = 'log') {
            const output = document.getElementById("console-output");
            const div = document.createElement("div");
            div.className = `log-row log-${type}`;
            div.innerText = msg;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        // Listen for console messages sent from the iframe
        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === 'console') {
                logToConsole(event.data.args.join(" "), event.data.level);
            }
        });

        // This script gets injected into the iframe to catch its console output safely
        const consoleInterceptorScript = `
            <script>
                (function() {
                    function serialize(arg) {
                        if (arg === null) return 'null';
                        if (arg === undefined) return 'undefined';
                        // Handle HTML Elements (like <canvas>)
                        if (arg instanceof HTMLElement) return '<' + arg.tagName.toLowerCase() + (arg.id ? ' id="' + arg.id + '"' : '') + '>';
                        // Handle Canvas Context specifically
                        if (arg.toString() === '[object CanvasRenderingContext2D]') return 'CanvasRenderingContext2D { canvas, fillStyle, ... }';
                        if (typeof arg === 'object') {
                            try { return JSON.stringify(arg, null, 2); } 
                            catch (e) { return Object.prototype.toString.call(arg); }
                        }
                        return arg.toString();
                    }

                    const methods = ['log', 'warn', 'error', 'info'];
                    methods.forEach(method => {
                        const original = console[method];
                        console[method] = function(...args) {
                            window.parent.postMessage({
                                type: 'console',
                                level: method,
                                args: args.map(serialize)
                            }, '*');
                            original.apply(console, args);
                        };
                    });

                    window.onerror = function(msg, url, line) {
                        console.error(msg + ' (Line: ' + line + ')');
                        return false;
                    };
                })();
            <\/script>
        `;

        // 6. The "Bundler" - Replaces <script src="..."> with inline files
        function runCode() {
            clearConsole();
            
            // Start with the user's index.html, or a blank string
            let htmlContent = files["index.html"] || "<h1>No index.html found</h1>";

            // Inject the console interceptor at the very top so it catches everything
            htmlContent = consoleInterceptorScript + htmlContent;

            // Find and replace <script src="filename.js">
            htmlContent = htmlContent.replace(/<script\s+[^>]*src=["']([^"']+)["'][^>]*>[\s\S]*?<\/script>/gi, (match, src) => {
                if (files[src]) {
                    // Escape closing script tags inside the JS to prevent HTML breaking
                    const safeJs = files[src].replace(/<\/script>/gi, "<\\/script>");
                    return `<script>${safeJs}<\/script>`;
                }
                return match; // If file isn't in our sandbox, leave it alone (e.g. external CDNs)
            });

            // Find and replace <link rel="stylesheet" href="filename.css">
            htmlContent = htmlContent.replace(/<link\s+[^>]*href=["']([^"']+)["'][^>]*>/gi, (match, href) => {
                if (files[href]) {
                    return `<style>${files[href]}</style>`;
                }
                return match;
            });

            // Push the bundled HTML into the iframe via srcdoc
            const iframe = document.getElementById("preview");
            iframe.srcdoc = htmlContent;
        }

        // Initialize app
        renderFileList();
        openFile("index.js"); // Open JS by default to show it's there
        openFile("index.html"); // Switch back to HTML to leave it active
        runCode(); // Run automatically on load

    </script>
</body>
</html>
